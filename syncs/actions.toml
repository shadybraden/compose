[[action]]
name = "ac-hoc"
[action.config]
file_contents = """
// Same as BatchDeployStacksIfChanged, but with an exclusion filter
console.log('Deploying all non-excluded stacks...\n');

// Get Tag Id. The API should throw if it's not found, but we employ safety checks just in case
const exclusionTagId = (await komodo.read("GetTag", { tag: "ad-hoc" }))?._id?.$oid ?? null; // YOUR TAG HERE
if (!exclusionTagId)
  console.log('Exclusion tag not found!\n');

// Deploy all stacks, minus the excluded ones
const allStacks = await komodo.read("ListStacks", {});
for(const stack of allStacks) {
  const name = stack.name;
  const id = stack.id;
  const tags = stack.tags;

  if(tags.includes(exclusionTagId)) {
    console.log('Skipping stack', name, '(excuded)')
    continue;
  }

  console.log('Deploying', name)
  await komodo.execute("DeployStackIfChanged", {
   stack: id,
  });
}

console.log('');
"""